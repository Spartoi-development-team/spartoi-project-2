name: quality-gates

on:
  pull_request:
  merge_group:
    types: [checks_requested]
  push:
    branches: [main]

jobs:
  gates:
    name: gates
    runs-on: ubuntu-latest
    env:
      VALE_VERSION: v3.13.0
      LYCHEE_VERSION: lychee-v0.22.0
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: pip
          cache-dependency-path: .github/ci/requirements-ci.txt

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm (optional)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install MkDocs + markdownlint-cli2 deps
        run: |
          pip install -r .github/ci/requirements-ci.txt
          # install markdownlint globally; create package-lock if needed
          npm i -g markdownlint-cli2 || true

      - name: Install lychee
        run: |
          set -euo pipefail
          BIN="$HOME/.local/bin"; mkdir -p "$BIN"
          export PATH="$BIN:$PATH"
          if [ -x "$BIN/lychee" ]; then
            "$BIN/lychee" --version || true
          else
            ASSET="lychee-x86_64-unknown-linux-gnu.tar.gz"
            URL="https://github.com/lycheeverse/lychee/releases/download/${LYCHEE_VERSION}/$ASSET"
            tmp="$(mktemp -d)"
            # retry curl with exponential backoff and timeouts
            curl --retry 5 --retry-delay 5 --retry-all-errors --connect-timeout 15 --max-time 120 -fsSL "$URL" -o "$tmp/lychee.tgz"
            tar -xzf "$tmp/lychee.tgz" -C "$tmp"
            install -m 0755 "$tmp/lychee" "$BIN/lychee"
            "$BIN/lychee" --version
          fi

      - name: Install vale
        run: |
          set -euo pipefail
          BIN="$HOME/.local/bin"; mkdir -p "$BIN"
          export PATH="$BIN:$PATH"
          if [ -x "$BIN/vale" ]; then
            "$BIN/vale" --version || true
          else
            VER="${VALE_VERSION#v}"
            ASSET="vale_${VER}_Linux_64-bit.tar.gz"
            URL="https://github.com/errata-ai/vale/releases/download/${VALE_VERSION}/$ASSET"
            tmp="$(mktemp -d)"
            curl -fsSL "$URL" -o "$tmp/vale.tgz"
            mkdir -p "$tmp/vale"
            tar -xzf "$tmp/vale.tgz" -C "$tmp/vale"
            install -m 0755 "$tmp/vale/vale" "$BIN/vale"
            "$BIN/vale" --version
          fi

      - name: Cache local bin (optional)
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.local/bin
          key: ${{ runner.os }}-local-bin-${{ env.VALE_VERSION }}-${{ env.LYCHEE_VERSION }}-${{ hashFiles('.github/ci/requirements-ci.txt') }}
          restore-keys: |
            ${{ runner.os }}-local-bin-

      - name: Run all local gates (fail-closed)
        run: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$PATH"
          bash scripts/gate_all_local.sh

      - name: Run acceptance (B1 minimal slice)
        run: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$PATH"
          bash scripts/acceptance.sh

      - name: Upload evidence artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b1-evidence
          path: |
            evidence/_b1
            evidence/evidence_index.json
            evidence/b2 || true
